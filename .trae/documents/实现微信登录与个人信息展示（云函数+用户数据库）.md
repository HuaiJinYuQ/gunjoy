## 目标
- 完成微信登录（云函数）并建立用户账户。
- 在个人信息页展示昵称、头像、性别、年龄等基础信息，可编辑性别与生日（用于计算年龄）。
- 给出所需素材清单与数据库字段设计。

## 技术方案
- 小程序前端：使用 `wx.login` 获取 `code`，调用云函数完成登录与建档；使用 `wx.getUserProfile`（可降级为 `open-type=getUserInfo`）获取昵称与头像并写入数据库；个人页读取并展示用户信息。
- 云函数：基于云开发（云函数中使用 `getWXContext` 获取 `openid/unionid`），完成用户的创建/更新与查询。
- 数据库存储：`users` 集合（单表），以 `openid` 作为主键；必要索引：`openid` 唯一、`unionid` 非唯一索引。
- 年龄来源：通过用户填写生日（`birthday`），后端计算年龄并返回，避免直接存储年龄的时效问题。

## 云函数设计
- `user_login`
  - 入参：`code`（预留）、`profile`（可选，包含 `nickname/avatarUrl`）
  - 逻辑：通过 `getWXContext()` 获取 `openid/unionid`；在 `users` 集合中查找并创建或更新用户；合并前端传入的 `profile`；返回用户基础信息。
- `user_update_profile`
  - 入参：`nickname?`、`avatarUrl?`、`gender?`、`birthday?`、`city?`、`province?`
  - 逻辑：鉴权（基于 `getWXContext().OPENID`），只允许更新自己的数据；写入后返回最新用户信息（含年龄计算）。
- `user_get_profile`
  - 入参：无
  - 逻辑：鉴权后根据 `openid` 读取用户信息，返回（含年龄计算）。

## 数据库设计
- 集合：`users`
- 字段：
  - `_id`: string（建议等于 `openid`，便于主键检索）
  - `openid`: string（与 `_id` 相同，唯一）
  - `unionid`: string | null（可选）
  - `nickname`: string
  - `avatarUrl`: string
  - `gender`: number（0 未知、1 男、2 女）
  - `birthday`: string（ISO 日期，如 `1998-07-15`）
  - `city`: string
  - `province`: string
  - `age`: number（不存库，运行时根据 `birthday` 计算并返回）
  - `preferences`: object（扩展：`genres: string[]`, `cities: string[]`, `priceRange: [number, number]`）
  - `stats`: object（扩展：`favorites: number`, `notes: number`）
  - `createdAt`: string（ISO 时间）
  - `updatedAt`: string（ISO 时间）
- 索引：
  - `openid` 唯一索引
  - `unionid` 普通索引

## 前端改动点
- `pages/profile/profile.ts`
  - 增加：登录流程（`wx.login` + 云函数 `user_login`）；获取 `wx.getUserProfile` 头像昵称并上报；读取/展示用户信息；编辑性别与生日后调用 `user_update_profile`。
  - 展示字段：头像、昵称、性别（中文显示）、年龄（后端返回）、城市、省份。
- `pages/profile/profile.wxml`
  - UI：信息卡片（头像+昵称）、信息行（性别、年龄、城市、省份）、编辑按钮（弹出选择/日期选择器）。
- `pages/profile/profile.wxss`
  - 适配上述卡片与信息行样式，保持主题色 `#FF6B35`。

## 安全与合规
- 不在数据库持久化 `session_key`；仅在云函数运行态使用 `getWXContext` 获取鉴权身份。
- 前端头像/昵称仅在用户授权后采集；未授权时显示占位头像与引导文案。
- 严格基于 `OPENID` 进行权限控制，避免越权修改他人资料。

## 素材清单（由你提供）
- `default-avatar.png`（64×64，≤40KB）
- `icon-gender-male.png`、`icon-gender-female.png`（24×24，≤20KB）
- `icon-edit.png`（24×24，≤20KB）
- 可选：`icon-birthday.png`（24×24，≤20KB）

## 验收标准
- 用户首次进入个人页，点击“授权并登录”后创建账户并展示昵称头像；未授权时显示默认头像与登录引导。
- 可编辑性别与生日，提交后页面显示正确年龄（生日变更年龄随之更新）。
- 所有云函数返回的数据包含基础字段，且 `users` 集合创建成功、索引生效。

## 交付内容
- 云函数：`user_login`、`user_update_profile`、`user_get_profile`
- 前端：个人页登录与信息展示逻辑、编辑表单与调用管道
- 文档：数据库字段与素材清单（如上）